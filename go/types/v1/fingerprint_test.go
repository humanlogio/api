package typesv1

import (
	"encoding/hex"
	"testing"

	"github.com/stretchr/testify/require"
	"google.golang.org/protobuf/types/known/durationpb"
	"google.golang.org/protobuf/types/known/timestamppb"
)

func TestFingerprintingStabilityAndEquivalence(t *testing.T) {
	// check that the fingerprint hashes don't change by mistake
	// and that generating fingerprints via various methods
	// yields the same hash
	tests := []struct {
		name     string
		inFlex   Valuer
		inNative *Val
		want     uint64
	}{
		{
			name:     "string",
			inFlex:   ValuerString("hello world"),
			inNative: ValStr("hello world"),
			want:     0xd51bc6e5e5e55060,
		},
		{
			name:     "trace_id",
			inFlex:   ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
			inNative: ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
			want:     0x7ba764bd63984a7c,
		},
		{
			name:     "span_id",
			inFlex:   ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
			inNative: ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
			want:     0x507d08e7656c0c59,
		},
		{
			name:     "ulid",
			inFlex:   ValuerULID(42, 69),
			inNative: ValULID(&ULID{High: 42, Low: 69}),
			want:     0x8e46eb170aecbc91,
		},
		{
			name:     "blob",
			inFlex:   ValuerBlob([]byte("lolololol")),
			inNative: ValBlob([]byte("lolololol")),
			want:     0xb583c15538d55d3d,
		},
		{
			name:     "null",
			inFlex:   ValuerNull(),
			inNative: ValNull(),
			want:     0x9aaba41ffa2da101,
		},
		{
			name:     "bool_true",
			inFlex:   ValuerBool(true),
			inNative: ValBool(true),
			want:     0x52fc4823a13c997a,
		},
		{
			name:     "bool_false",
			inFlex:   ValuerBool(false),
			inNative: ValBool(false),
			want:     0xdd8f621dbf7f57f1,
		},
		{
			name:     "i64",
			inFlex:   ValuerI64(666),
			inNative: ValI64(666),
			want:     0x646b7a027e623070,
		},
		{
			name:     "f64",
			inFlex:   ValuerF64(123.456789),
			inNative: ValF64(123.456789),
			want:     0x2374c61b9f60cd7f,
		},
		{
			name:     "hash64",
			inFlex:   ValuerHash64(0x2374c61b9f60cd7f),
			inNative: ValHash64(0x2374c61b9f60cd7f),
			want:     0xfeedafa8721cee71,
		},
		{
			name:     "timestamp",
			inFlex:   ValuerTimestamp(1745971200, 50042),
			inNative: ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
			want:     0xeee5ec8c1147bb7d,
		},
		{
			name:     "duration_time",
			inFlex:   ValuerDuration(1745971200, 50042),
			inNative: ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
			want:     0xd76a8183751862ad,
		},
		{
			name:     "duration_pb",
			inFlex:   ValuerDuration(1745971200, 50042),
			inNative: ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
			want:     0xd76a8183751862ad,
		},
		{
			name: "array",
			inFlex: ValuerArr(ValuerIteratorFromSlice([]Valuer{
				ValuerString("hello world"),
				ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
				ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
				ValuerULID(42, 69),
				ValuerBlob([]byte("lolololol")),
				ValuerNull(),
				ValuerBool(true),
				ValuerBool(false),
				ValuerI64(666),
				ValuerF64(123.456789),
				ValuerHash64(0x2374c61b9f60cd7f),
				ValuerTimestamp(1745971200, 50042),
				ValuerDuration(1745971200, 50042),
				ValuerDuration(1745971200, 50042),
				ValuerObj(ValuerIteratorFromObjMap(map[string]Valuer{
					"valuer_string":      ValuerString("hello world"),
					"valuer_trace_id":    ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
					"valuer_span_id":     ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
					"valuer_ulid":        ValuerULID(42, 69),
					"valuer_blob":        ValuerBlob([]byte("lolololol")),
					"valuer_null":        ValuerNull(),
					"valuer_bool_true":   ValuerBool(true),
					"valuer_bool_false":  ValuerBool(false),
					"valuer_i64":         ValuerI64(666),
					"valuer_f64":         ValuerF64(123.456789),
					"valuer_hash64":      ValuerHash64(0x2374c61b9f60cd7f),
					"valuer_timestamp":   ValuerTimestamp(1745971200, 50042),
					"valuer_duration":    ValuerDuration(1745971200, 50042),
					"valuer_duration_pb": ValuerDuration(1745971200, 50042),
					"valuer_arr": ValuerArr(ValuerIteratorFromSlice([]Valuer{
						ValuerString("hello world"),
						ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
						ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
						ValuerULID(42, 69),
						ValuerBlob([]byte("lolololol")),
						ValuerNull(),
						ValuerBool(true),
						ValuerBool(false),
						ValuerI64(666),
						ValuerF64(123.456789),
						ValuerHash64(0x2374c61b9f60cd7f),
						ValuerTimestamp(1745971200, 50042),
						ValuerDuration(1745971200, 50042),
						ValuerDuration(1745971200, 50042),
					})),
				})),
			})),
			inNative: ValArr(
				ValStr("hello world"),
				ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
				ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
				ValULID(&ULID{High: 42, Low: 69}),
				ValBlob([]byte("lolololol")),
				ValNull(),
				ValBool(true),
				ValBool(false),
				ValI64(666),
				ValF64(123.456789),
				ValHash64(0x2374c61b9f60cd7f),
				ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
				ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
				ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
				ValObj(
					KeyVal("valuer_string", ValStr("hello world")),
					KeyVal("valuer_trace_id", ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")})),
					KeyVal("valuer_span_id", ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")})),
					KeyVal("valuer_ulid", ValULID(&ULID{High: 42, Low: 69})),
					KeyVal("valuer_blob", ValBlob([]byte("lolololol"))),
					KeyVal("valuer_null", ValNull()),
					KeyVal("valuer_bool_true", ValBool(true)),
					KeyVal("valuer_bool_false", ValBool(false)),
					KeyVal("valuer_i64", ValI64(666)),
					KeyVal("valuer_f64", ValF64(123.456789)),
					KeyVal("valuer_hash64", ValHash64(0x2374c61b9f60cd7f)),
					KeyVal("valuer_timestamp", ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042})),
					KeyVal("valuer_duration", ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration())),
					KeyVal("valuer_duration_pb", ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042})),
					KeyVal("valuer_arr", ValArr(
						ValStr("hello world"),
						ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
						ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
						ValULID(&ULID{High: 42, Low: 69}),
						ValBlob([]byte("lolololol")),
						ValNull(),
						ValBool(true),
						ValBool(false),
						ValI64(666),
						ValF64(123.456789),
						ValHash64(0x2374c61b9f60cd7f),
						ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
						ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
						ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
					)),
				),
			),
			want: 0xd23056e5594b15c2,
		},
		{
			name: "obj",
			inFlex: ValuerObj(ValuerIteratorFromObjMap(map[string]Valuer{
				"valuer_string":      ValuerString("hello world"),
				"valuer_trace_id":    ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
				"valuer_span_id":     ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
				"valuer_ulid":        ValuerULID(42, 69),
				"valuer_blob":        ValuerBlob([]byte("lolololol")),
				"valuer_null":        ValuerNull(),
				"valuer_bool_true":   ValuerBool(true),
				"valuer_bool_false":  ValuerBool(false),
				"valuer_i64":         ValuerI64(666),
				"valuer_f64":         ValuerF64(123.456789),
				"valuer_hash64":      ValuerHash64(0x2374c61b9f60cd7f),
				"valuer_timestamp":   ValuerTimestamp(1745971200, 50042),
				"valuer_duration":    ValuerDuration(1745971200, 50042),
				"valuer_duration_pb": ValuerDuration(1745971200, 50042),
				"valuer_arr": ValuerArr(ValuerIteratorFromSlice([]Valuer{
					ValuerString("hello world"),
					ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
					ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
					ValuerULID(42, 69),
					ValuerBlob([]byte("lolololol")),
					ValuerNull(),
					ValuerBool(true),
					ValuerBool(false),
					ValuerI64(666),
					ValuerF64(123.456789),
					ValuerHash64(0x2374c61b9f60cd7f),
					ValuerTimestamp(1745971200, 50042),
					ValuerDuration(1745971200, 50042),
					ValuerDuration(1745971200, 50042),
				})),
			})),
			inNative: ValObj(
				KeyVal("valuer_string", ValStr("hello world")),
				KeyVal("valuer_trace_id", ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")})),
				KeyVal("valuer_span_id", ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")})),
				KeyVal("valuer_ulid", ValULID(&ULID{High: 42, Low: 69})),
				KeyVal("valuer_blob", ValBlob([]byte("lolololol"))),
				KeyVal("valuer_null", ValNull()),
				KeyVal("valuer_bool_true", ValBool(true)),
				KeyVal("valuer_bool_false", ValBool(false)),
				KeyVal("valuer_i64", ValI64(666)),
				KeyVal("valuer_f64", ValF64(123.456789)),
				KeyVal("valuer_hash64", ValHash64(0x2374c61b9f60cd7f)),
				KeyVal("valuer_timestamp", ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042})),
				KeyVal("valuer_duration", ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration())),
				KeyVal("valuer_duration_pb", ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042})),
				KeyVal("valuer_arr", ValArr(
					ValStr("hello world"),
					ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
					ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
					ValULID(&ULID{High: 42, Low: 69}),
					ValBlob([]byte("lolololol")),
					ValNull(),
					ValBool(true),
					ValBool(false),
					ValI64(666),
					ValF64(123.456789),
					ValHash64(0x2374c61b9f60cd7f),
					ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
					ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
					ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
				)),
			),
			want: 0x16e4a885e4242705,
		},
		{
			name: "map",
			inFlex: ValuerMap(ValuerIteratorFromMap([]ValuerMapEntry{
				{ValuerString("valuer_string"), ValuerString("hello world")},
				{ValuerString("valuer_trace_id"), ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9"))},
				{ValuerString("valuer_span_id"), ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df"))},
				{ValuerString("valuer_ulid"), ValuerULID(42, 69)},
				{ValuerString("valuer_blob"), ValuerBlob([]byte("lolololol"))},
				{ValuerString("valuer_null"), ValuerNull()},
				{ValuerString("valuer_bool_true"), ValuerBool(true)},
				{ValuerString("valuer_bool_false"), ValuerBool(false)},
				{ValuerString("valuer_i64"), ValuerI64(666)},
				{ValuerString("valuer_f64"), ValuerF64(123.456789)},
				{ValuerString("valuer_hash64"), ValuerHash64(0x2374c61b9f60cd7f)},
				{ValuerString("valuer_timestamp"), ValuerTimestamp(1745971200, 50042)},
				{ValuerString("valuer_duration"), ValuerDuration(1745971200, 50042)},
				{ValuerString("valuer_duration_pb"), ValuerDuration(1745971200, 50042)},
				{ValuerString("valuer_arr"), ValuerArr(ValuerIteratorFromSlice([]Valuer{
					ValuerString("hello world"),
					ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
					ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
					ValuerULID(42, 69),
					ValuerBlob([]byte("lolololol")),
					ValuerNull(),
					ValuerBool(true),
					ValuerBool(false),
					ValuerI64(666),
					ValuerF64(123.456789),
					ValuerHash64(0x2374c61b9f60cd7f),
					ValuerTimestamp(1745971200, 50042),
					ValuerDuration(1745971200, 50042),
					ValuerDuration(1745971200, 50042),
				}))},
			})),
			inNative: ValMap(TypeStr(), TypeUnknown(),
				&Map_Entry{Key: ValStr("valuer_string"), Value: ValStr("hello world")},
				&Map_Entry{Key: ValStr("valuer_trace_id"), Value: ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")})},
				&Map_Entry{Key: ValStr("valuer_span_id"), Value: ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")})},
				&Map_Entry{Key: ValStr("valuer_ulid"), Value: ValULID(&ULID{High: 42, Low: 69})},
				&Map_Entry{Key: ValStr("valuer_blob"), Value: ValBlob([]byte("lolololol"))},
				&Map_Entry{Key: ValStr("valuer_null"), Value: ValNull()},
				&Map_Entry{Key: ValStr("valuer_bool_true"), Value: ValBool(true)},
				&Map_Entry{Key: ValStr("valuer_bool_false"), Value: ValBool(false)},
				&Map_Entry{Key: ValStr("valuer_i64"), Value: ValI64(666)},
				&Map_Entry{Key: ValStr("valuer_f64"), Value: ValF64(123.456789)},
				&Map_Entry{Key: ValStr("valuer_hash64"), Value: ValHash64(0x2374c61b9f60cd7f)},
				&Map_Entry{Key: ValStr("valuer_timestamp"), Value: ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042})},
				&Map_Entry{Key: ValStr("valuer_duration"), Value: ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration())},
				&Map_Entry{Key: ValStr("valuer_duration_pb"), Value: ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042})},
				&Map_Entry{Key: ValStr("valuer_arr"), Value: ValArr(
					ValStr("hello world"),
					ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
					ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
					ValULID(&ULID{High: 42, Low: 69}),
					ValBlob([]byte("lolololol")),
					ValNull(),
					ValBool(true),
					ValBool(false),
					ValI64(666),
					ValF64(123.456789),
					ValHash64(0x2374c61b9f60cd7f),
					ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
					ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
					ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
				)},
			),
			want: 0xf90280d704efd25,
		},

		// invariant checks
		{
			name: "obj order doesn't matter",
			inFlex: ValuerObj(ValuerIteratorFromObjMap(map[string]Valuer{
				"valuer_trace_id":    ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
				"valuer_span_id":     ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
				"valuer_ulid":        ValuerULID(42, 69),
				"valuer_blob":        ValuerBlob([]byte("lolololol")),
				"valuer_string":      ValuerString("hello world"),
				"valuer_null":        ValuerNull(),
				"valuer_bool_true":   ValuerBool(true),
				"valuer_bool_false":  ValuerBool(false),
				"valuer_duration_pb": ValuerDuration(1745971200, 50042),
				"valuer_i64":         ValuerI64(666),
				"valuer_f64":         ValuerF64(123.456789),
				"valuer_hash64":      ValuerHash64(0x2374c61b9f60cd7f),
				"valuer_timestamp":   ValuerTimestamp(1745971200, 50042),
				"valuer_duration":    ValuerDuration(1745971200, 50042),
				"valuer_arr": ValuerArr(ValuerIteratorFromSlice([]Valuer{
					ValuerString("hello world"),
					ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
					ValuerF64(123.456789),
					ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
					ValuerULID(42, 69),
					ValuerBlob([]byte("lolololol")),
					ValuerNull(),
					ValuerBool(true),
					ValuerBool(false),
					ValuerHash64(0x2374c61b9f60cd7f),
					ValuerTimestamp(1745971200, 50042),
					ValuerDuration(1745971200, 50042),
					ValuerI64(666),
					ValuerDuration(1745971200, 50042),
				})),
			})),
			inNative: ValObj(
				KeyVal("valuer_string", ValStr("hello world")),
				KeyVal("valuer_ulid", ValULID(&ULID{High: 42, Low: 69})),
				KeyVal("valuer_null", ValNull()),
				KeyVal("valuer_bool_true", ValBool(true)),
				KeyVal("valuer_trace_id", ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")})),
				KeyVal("valuer_span_id", ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")})),
				KeyVal("valuer_f64", ValF64(123.456789)),
				KeyVal("valuer_blob", ValBlob([]byte("lolololol"))),
				KeyVal("valuer_hash64", ValHash64(0x2374c61b9f60cd7f)),
				KeyVal("valuer_timestamp", ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042})),
				KeyVal("valuer_duration", ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration())),
				KeyVal("valuer_duration_pb", ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042})),
				KeyVal("valuer_arr", ValArr(
					ValStr("hello world"),
					ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
					ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
					ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
					ValBlob([]byte("lolololol")),
					ValNull(),
					ValBool(true),
					ValBool(false),
					ValI64(666),
					ValULID(&ULID{High: 42, Low: 69}),
					ValF64(123.456789),
					ValHash64(0x2374c61b9f60cd7f),
					ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
					ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
				)),
				KeyVal("valuer_bool_false", ValBool(false)),
				KeyVal("valuer_i64", ValI64(666)),
			),
			want: 0x16e4a885e4242705,
		},
		{
			name: "map order doesn't matter",
			inFlex: ValuerMap(ValuerIteratorFromMap([]ValuerMapEntry{
				{ValuerString("valuer_bool_false"), ValuerBool(false)},
				{ValuerString("valuer_i64"), ValuerI64(666)},
				{ValuerString("valuer_f64"), ValuerF64(123.456789)},
				{ValuerString("valuer_hash64"), ValuerHash64(0x2374c61b9f60cd7f)},
				{ValuerString("valuer_blob"), ValuerBlob([]byte("lolololol"))},
				{ValuerString("valuer_null"), ValuerNull()},
				{ValuerString("valuer_arr"), ValuerArr(ValuerIteratorFromSlice([]Valuer{
					ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")),
					ValuerI64(666),
					ValuerF64(123.456789),
					ValuerHash64(0x2374c61b9f60cd7f),
					ValuerTimestamp(1745971200, 50042),
					ValuerDuration(1745971200, 50042),
					ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df")),
					ValuerULID(42, 69),
					ValuerBlob([]byte("lolololol")),
					ValuerNull(),
					ValuerBool(true),
					ValuerString("hello world"),
					ValuerBool(false),
					ValuerDuration(1745971200, 50042),
				}))},
				{ValuerString("valuer_bool_true"), ValuerBool(true)},
				{ValuerString("valuer_timestamp"), ValuerTimestamp(1745971200, 50042)},
				{ValuerString("valuer_duration"), ValuerDuration(1745971200, 50042)},
				{ValuerString("valuer_duration_pb"), ValuerDuration(1745971200, 50042)},
				{ValuerString("valuer_string"), ValuerString("hello world")},
				{ValuerString("valuer_trace_id"), ValuerTraceID(hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9"))},
				{ValuerString("valuer_span_id"), ValuerSpanID(hexToBytes(t, "aa071ea68f7b58df"))},
				{ValuerString("valuer_ulid"), ValuerULID(42, 69)},
			})),
			inNative: ValMap(TypeStr(), TypeUnknown(),
				&Map_Entry{Key: ValStr("valuer_string"), Value: ValStr("hello world")},
				&Map_Entry{Key: ValStr("valuer_trace_id"), Value: ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")})},
				&Map_Entry{Key: ValStr("valuer_span_id"), Value: ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")})},
				&Map_Entry{Key: ValStr("valuer_ulid"), Value: ValULID(&ULID{High: 42, Low: 69})},
				&Map_Entry{Key: ValStr("valuer_blob"), Value: ValBlob([]byte("lolololol"))},
				&Map_Entry{Key: ValStr("valuer_null"), Value: ValNull()},
				&Map_Entry{Key: ValStr("valuer_bool_true"), Value: ValBool(true)},
				&Map_Entry{Key: ValStr("valuer_bool_false"), Value: ValBool(false)},
				&Map_Entry{Key: ValStr("valuer_i64"), Value: ValI64(666)},
				&Map_Entry{Key: ValStr("valuer_f64"), Value: ValF64(123.456789)},
				&Map_Entry{Key: ValStr("valuer_hash64"), Value: ValHash64(0x2374c61b9f60cd7f)},
				&Map_Entry{Key: ValStr("valuer_timestamp"), Value: ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042})},
				&Map_Entry{Key: ValStr("valuer_duration"), Value: ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration())},
				&Map_Entry{Key: ValStr("valuer_duration_pb"), Value: ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042})},
				&Map_Entry{Key: ValStr("valuer_arr"), Value: ValArr(
					ValStr("hello world"),
					ValTraceID(&TraceID{Raw: hexToBytes(t, "87951ca8e63350cd631e1d0e31b0dbd9")}),
					ValSpanID(&SpanID{Raw: hexToBytes(t, "aa071ea68f7b58df")}),
					ValULID(&ULID{High: 42, Low: 69}),
					ValBlob([]byte("lolololol")),
					ValNull(),
					ValBool(true),
					ValBool(false),
					ValI64(666),
					ValF64(123.456789),
					ValHash64(0x2374c61b9f60cd7f),
					ValTimestamp(&timestamppb.Timestamp{Seconds: 1745971200, Nanos: 50042}),
					ValDuration((&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}).AsDuration()),
					ValDurationPB(&durationpb.Duration{Seconds: 1745971200, Nanos: 50042}),
				)},
			),
			want: 0xf90280d704efd25,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			gotFlex := Hash64Any(tt.inFlex)
			gotNative := Hash64Value(tt.inNative)
			gotNativeToFlex := Hash64Any(ValuerVal(tt.inNative))
			require.Equal(t, tt.want, gotFlex, "flex hashing")
			require.Equal(t, tt.want, gotNative, "native hashing")
			require.Equal(t, tt.want, gotNativeToFlex, "native to flex hashing")
		})
	}
}

func hexToBytes(t testing.TB, val string) []byte {
	out, err := hex.DecodeString(val)
	require.NoError(t, err)
	return out
}
